$.fn.miaChat=function(e){var t="admin",a="auth",n="chat",i="focus",s="blur",o="refresh",r="adminJoin",c="quickRate",m="rate",p="chat",l="rate",d="isMiaChatOpened",u=$.extend({address:"",greeting:"",chatId:null,author:"guest",adminName:"Emily Warren",visitorName:"Visitor",uploadUrl:"",chatRate:null,clientIp:"",timeout:36e5},e),h=u.author===t?u.adminName:u.visitorName,g=$(this),f=$(window.parent.document),k=function(){return new WebSocket(u.address)},v={form:g.find(".mia-message-form"),input:g.find(".mia-message-form").find('input[name="message"]'),webSocket:k(),lastMessageTimestamp:null,init:function(){u.chatId&&v.chatId.set(u.chatId),v.template.renderQuickRate(u.chatRate),v.template.checkMessages(),v.webSocket.onerror=v.socket.refresh,v.webSocket.onclose=v.socket.refresh,v.webSocket.onopen=v.events.auth,v.webSocket.onmessage=v.events.acceptMessage,v.template.greetingHeader.on("click",v.template.openChat),f.find('[data-mia-chat="open"]').on("click",v.template.openChat),$(document).on("mia:open",v.template.openChat),v.template.dynamicHeader.on("click",v.template.closeChat),v.template.rateHeader.on("click",v.template.closeChat),f.find('[data-mia-chat="close"]').on("click",v.template.closeChat),$(document).on("mia:close",v.template.closeChat),v.template.styledFileInput.on("click",v.template.stylingFileInput),v.template.fileInput.on("change",v.events.uploadFile),v.template.rateButtons.on("click",v.events.quickRateChat),v.template.rateCancelButton.on("click",v.events.quitChat),v.template.rateForm.on("submit",v.events.rateChat),v.input.on("focus",v.events.startTyping),v.input.on("blur",v.events.stopTyping),v.form.on("submit",v.events.sendMessage),g.on("expanded.boxwidget",v.template.scrollDown),v.template.quitButton.on("click",function(e){e.stopPropagation(),v.template.adminCard.is(":visible")?v.events.moveToRate():v.events.quitChat()}),setInterval(v.events.checkOverdue,6e4),setInterval(v.socket.ping,3e4),setInterval(v.template.checkMessages,1e3),v.storage.get(d)?v.template.openChat():v.template.closeChat()},socket:{refresh:function(){var e=v.webSocket.readyState===v.webSocket.CONNECTING,t=v.webSocket.readyState===v.webSocket.OPEN;e||t||(console.warn("Socket: Connection is broken... Reconnecting..."),v.webSocket=k(),v.init())},ping:function(){v.socket.push("ping",{})},push:function(e,t){var a=v.chatId.get();a?v.chatId.set(a):a=null;var n=$.extend({action:e,chat_id:a,author:u.author,url:window.parent.location.href,ip:u.clientIp},t);v.webSocket.readyState===v.webSocket.OPEN?v.webSocket.send(JSON.stringify(n)):console.warn('Socket: Event "'+e+'" can not be proceeded')}},parent:{pushEvent:function(e){var t=new Event(e);window.parent.document.dispatchEvent(t)}},events:{auth:function(){console.info("Socket: Connection established"),v.socket.push(a,{}),u.author===t&&v.events.joinChat()},joinChat:function(e){"object"==typeof e&&e.stopPropagation(),v.socket.push(r,{noReply:!0})},acceptMessage:function(e){var t=JSON.parse(e.data);switch(t.action){case a:v.chatId.set(t.chat_id);break;case"greeting":v.template.renderGreeting(t.html);break;case i:v.template.renderNotification(t.message,t.target,"focus");break;case s:v.template.removeNotification(t.target,"focus");break;case"list":v.template.renderMessage(t.messages,!1);break;case n:v.parent.pushEvent("mia:message"),v.template.renderMessage(t.message,!0);break;case o:v.chatId.delete(),v.template.renderMessage("",!1),v.storage.setStatement(p),v.template.openChat(),v.events.auth();break;case r:v.template.renderAdminCard(t.card);break;case"adminLeft":v.template.adminCard.show();break;case c:v.template.renderQuickRate(t.rate);var l=100===t.rate?"good":"bad";v.socket.push(n,{message:"You rated our customer service as "+l+".",noReply:!0,is_system:!0});break;case m:v.events.quitChat()}},startTyping:function(){v.socket.push(i,{noReply:!1})},stopTyping:function(){v.socket.push(s,{noReply:!1})},sendMessage:function(){var e=v.input.val();return e.length&&(v.socket.push(n,{message:e,noReply:!1,is_system:!1}),v.input.val(""),v.events.stopTyping()),!1},moveToRate:function(e){"object"==typeof e&&e.stopPropagation(),v.storage.setStatement(l),v.template.openChat()},quitChat:function(e){return"object"==typeof e&&e.stopPropagation(),v.socket.push(n,{message:h+" left the chat",noReply:!1,is_system:!0}),v.socket.push(o,{}),!1},checkOverdue:function(){var e=(new Date).getTime();null!==v.lastMessageTimestamp&&e-v.lastMessageTimestamp>=u.timeout&&v.events.quitChat()},uploadFile:function(e){e.stopPropagation();var t=new FormData;t.append("chatId",v.chatId.get()),$.each(e.target.files,function(e,a){t.append("uploads["+e+"]",a)}),$.ajax({url:u.uploadUrl,type:"POST",cache:!1,data:t,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){v.template.styledFileInput.hide(),v.template.styledFileLoader.show()},success:function(e){for(var t in e){var a=e[t];"success"===a.type?v.socket.push(n,{message:a.name,attachment:a.rout,is_system:!1}):v.socket.push(n,{message:a.message,attachment:"",is_system:!1})}},complete:function(){v.template.styledFileLoader.hide(),v.template.styledFileInput.show()}})},quickRateChat:function(e){return"object"==typeof e&&e.stopPropagation(),v.socket.push(c,{rate:$(this).data("mia-rate")}),!1},rateChat:function(e){"object"==typeof e&&e.stopPropagation();var t=v.template.ratePart.find("[data-mia-rate].active");return v.socket.push(m,{rate:t.length?t.data("mia-rate"):null,comment:v.template.rateInput.val()}),v.template.rateInput.val(""),!1}},template:{greeting:g.find(".mia-chat-greeting"),main:g.find(".mia-chat-messages"),system:g.find(".mia-chat-system-messages"),quitButton:g.find('[data-chat-action="quit"]'),adminCard:g.find(".mia-chat-admin-card"),dynamicPart:g.find(".mia-chat-dynamic-part"),dynamicHeader:g.find(".mia-chat-dynamic-part .mia-chat-header"),dynamicHeaderText:g.find(".mia-chat-dynamic-part .mia-chat-header").find(".mia-chat-header-text"),greetingHeader:g.find(".mia-chat-greeting-part .mia-chat-header"),fileInput:g.find(".mia-chat-file-input-wrapper .mia-chat-file-input"),styledFileInput:g.find(".mia-chat-file-input-wrapper .mia-chat-styled-file-input"),styledFileLoader:g.find(".mia-chat-file-input-wrapper .mia-chat-styled-file-loader"),ratePart:g.find(".mia-chat-rate-part"),rateHeader:g.find(".mia-chat-rate-part .mia-chat-header"),rateForm:g.find(".mia-chat-rate-part form"),rateButtons:g.find("[data-mia-rate]"),rateInput:g.find('.mia-chat-rate-part textarea[name="comment"]'),rateCancelButton:g.find(".mia-chat-rate-part .mia-rate-cancel-button"),openChat:function(){switch(v.storage.getStatement()){case p:v.template.greetingHeader.hide(),v.template.ratePart.hide(),v.template.dynamicHeader.show(),v.template.dynamicPart.show(),v.template.scrollDown();break;case l:v.template.dynamicPart.hide(),v.template.dynamicHeader.hide(),v.template.greetingHeader.hide(),v.template.ratePart.show()}v.storage.set(d,!0),v.parent.pushEvent("mia:isOpened")},closeChat:function(){v.template.dynamicPart.hide(),v.template.dynamicHeader.hide(),v.template.ratePart.hide(),v.template.greetingHeader.show(),v.storage.set(d,!1),v.parent.pushEvent("mia:isClosed")},renderQuickRate:function(e){v.template.rateButtons.removeClass("active"),g.find('[data-mia-rate="'+e+'"]').addClass("active")},renderGreeting:function(e){v.template.main.addClass("empty"),v.template.adminCard.hide(),v.template.dynamicHeaderText.hide(),v.template.greeting.html(e)},renderMessage:function(e,t){v.template.greeting.html(""),v.template.main.removeClass("empty"),v.template.dynamicHeaderText.show(),t?v.template.main.append(e):v.template.main.html(e),v.template.scrollDown(),e.length?v.lastMessageTimestamp=(new Date).getTime():v.lastMessageTimestamp=null,v.template.checkMessages()},renderNotification:function(e,t,a){v.template.removeNotification(t,a),t===u.author&&v.template.system.append(e)},renderAdminCard:function(e){v.template.adminCard.find(".mia-admin-personal-data").html(e),$(v.template.adminCard).show(),console.log(v.template.adminCard)},removeNotification:function(e,t){v.template.system.find('[data-target="'+e+'"][data-event="'+t+'"]').remove()},scrollDown:function(e){"object"==typeof e&&e.stopPropagation(),v.template.main.animate({scrollTop:v.template.main.prop("scrollHeight")},0)},stylingFileInput:function(e){"object"==typeof e&&e.stopPropagation(),v.template.fileInput.click()},checkMessages:function(){null===v.lastMessageTimestamp?v.template.quitButton.hide():v.template.quitButton.show()}},storage:{set:function(e,t){localStorage.setItem(e,t)},get:function(e){var t=localStorage.getItem(e);switch(t){case"true":return!0;case"false":return!1;default:return t}},setStatement:function(e){localStorage.setItem("mia-statement",e)},getStatement:function(){var e=localStorage.getItem("mia-statement");return e||(e=p),e}},chatId:{get:function(){var e=Cookies.get("mia-id");return e||(u.chatId?u.chatId:null)},set:function(e){u.chatId=e,Cookies.set("mia-id",e,{expires:365})},delete:function(){u.chatId=null,Cookies.remove("mia-id")}}};v.init()};